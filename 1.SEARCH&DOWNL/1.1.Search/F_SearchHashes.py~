#This script use the VIRUSTOTAL API to request for hashes (query: 'positives:1+' for malware  OR query: 'positives:0 tag:nsrl')

#!/usr/bin/python

import sys
import requests
import json
import time

header = 'search'
extension = '.json'

counter = 1
myfile = ""
myoffset=''
temp =''
mainpath = '/path/'
newfile=""
Query = 'XX'

if counter == 1:
    myfile = mainpath + header + str(counter) + extension
    params = {'apikey': 'XXXX', 'query': Query}
    print Query
    response = requests.get('https://www.virustotal.com/vtapi/v2/file/search', params=params)
    json_response = response.json()
    with open(myfile, 'w') as outfile:
	json.dump(json_response, outfile, indent=2, sort_keys=True)
    input_file=open(myfile, 'r')
    json_decode=json.load(input_file)    
    temp=json_decode.get('offset')       
    if temp == None:
	print "Finished"
    else: 
	myoffset = temp
	counter = counter+1

while myoffset :
    myfile = mainpath + header + str(counter) + extension
    params = {'apikey': 'XXXX', 'query': Query, 'offset': myoffset}
    response = requests.get('https://www.virustotal.com/vtapi/v2/file/search', params=params)
    json_response = response.json()
    with open(myfile, 'w') as outfile:
	json.dump(json_response, outfile, indent=2, sort_keys=True)
	time.sleep(5)
    input_file=open(myfile, 'r')
    json_decode=json.load(input_file)    
    temp=json_decode.get('offset')
    if temp == None:
	temp2 = json_decode.get('response_code')
	if temp2 == -1:
	    time.sleep(5)
	else:
	    print "END"
	    myoffset = ""
    else:
	myoffset = temp
	counter = counter+1
