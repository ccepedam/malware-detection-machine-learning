#This script use the VIRUSTOTAL API to request for hashes for malware (query: 'positives:1+')
#!/usr/bin/python

import sys
import requests
import json

header = 'search_virus'
extension = '.json'

counter = 2
myfile = ""

#After downloading and reaching the maximum number of hashes per request, the "offset" is retrived to continue with the search
myoffset = 'ZZZZZZZZZZZZZZZZZZZ'
mainpath = '/path/'
newfile=""
##while myoffset != 'None':
hhh = 0
while hhh < 3 :
    myfile = header + str(counter) + extension
    #Query
    params = {'apikey': 'XXXX', 'query': 'positives:1+', 'offset': ''}
    response = requests.get('https://www.virustotal.com/vtapi/v2/file/search', params=params)
    json_response = response.json()
    #Open and write to the file
    with open(myfile, 'w') as outfile:
        json.dump(json_response, outfile, indent=2, sort_keys=True)
    newfile = mainpath + myfile
    input_file=open(newfile, 'r')
    json_decode=json.load(input_file)
    try:
        myoffset=json_decode.get('offset')
        break
    except ValueError:
        print "FIN"
        myoffset = 'None'
    hhh = hhh+1
		



