#!/usr/bin/python

import sys
import requests
import json
import time

header = 'search_virusNew'
extension = '.json'

counter = 1
myfile = ""
myoffset=''
temp =''
mainpath = '/home/carlos/Documents/MalwNew2016/SearchMalNew/Search2016/'
newfile=""
Q1 = 'positives:1+ '
Q2 = 'fs:2016-01-01T12:00:00+'
Query = Q1+Q2

if counter == 1:
    myfile = mainpath + header + str(counter) + extension
    params = {'apikey': 'ea519e15e2ed231d024dc4a2b7b6ec17efa1a851a2db01fa8391ef46ff73a523', 'query': Query}
    print Query
    response = requests.get('https://www.virustotal.com/vtapi/v2/file/search', params=params)
    json_response = response.json()
    with open(myfile, 'w') as outfile:
	json.dump(json_response, outfile, indent=2, sort_keys=True)
    input_file=open(myfile, 'r')
    json_decode=json.load(input_file)    
    temp=json_decode.get('offset')       
    if temp == None:
	print "Finished"
    else: 
	myoffset = temp
	counter = counter+1

while myoffset :
    myfile = mainpath + header + str(counter) + extension
    params = {'apikey': 'ea519e15e2ed231d024dc4a2b7b6ec17efa1a851a2db01fa8391ef46ff73a523', 'query': Query, 'offset': myoffset}
    response = requests.get('https://www.virustotal.com/vtapi/v2/file/search', params=params)
    json_response = response.json()
    with open(myfile, 'w') as outfile:
	json.dump(json_response, outfile, indent=2, sort_keys=True)
	time.sleep(5)
    input_file=open(myfile, 'r')
    json_decode=json.load(input_file)    
    temp=json_decode.get('offset')
    if temp == None:
	temp2 = json_decode.get('response_code')
	if temp2 == -1:
	    time.sleep(5)
	else:
	    print "END"
	    myoffset = ""
    else:
	myoffset = temp
	counter = counter+1
