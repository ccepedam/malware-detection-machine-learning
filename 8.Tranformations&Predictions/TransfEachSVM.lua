--This Code Create a new matrix from applying SVM to each feature vector to an input matrix 

require 'svm'
require 'nn'
require 'optim'
require 'torch'
require 'itorch'
require 'image'
require 'gnuplot'
require 'csvigo'


time = os.date("*t")
print(time.hour .. ":" .. time.min .. ":" .. time.sec)

trainSize = 8942
testSize = 2980
validationSize = 2980
features = 31


local path = '/home/gpulab/Documents/CARLOSCM/WorkingOnTorch/DATA_for_Torch/'


trainDataFileTENSOR= torch.load(path .. features .. 'train.th7')
trainLabelFileTENSOR=torch.load(path .. features .. 'trainlabel.th7')
testDataFileTENSOR= torch.load(path .. features .. 'test.th7')
testLabelFileTENSOR= torch.load(path .. features .. 'testlabel.th7')


TTrain2 = trainDataFileTENSOR:clone()
TTest2 = testDataFileTENSOR:clone()


function parsingLines(labelT, trainT, k)
  local label = tonumber(labelT[1])
  if label == 2 then label = -1 end
  label = tonumber(label)
  local vals = {}
  local inds = {}
	local indcntr = 0
  for j=k,k do --for j=1,trainT:size(1) do
    indcntr = indcntr + 1
		ind = tonumber(indcntr)
    val = tonumber(trainT[j])
    table.insert(inds,ind)
		table.insert(vals,val)
  end
  return label,{torch.IntTensor(inds),torch.FloatTensor(vals)}
end  


function createSVMDataset(datafile, labelfile, k) 
  
  local trainTensor = datafile
  local labelTensor = labelfile
  local data = {}
	local maxdim = 0
	local npos = 0
	local nneg = 0
    
	for i=1,trainTensor:size(1) do
    local lbl,vals = parsingLines(labelTensor[i], trainTensor[i], k)
		table.insert(data,{lbl,vals})
		maxdim = math.max(maxdim,vals[1][-1])
    --print(maxdim)
		if lbl == 1 then npos = npos + 1 else nneg = nneg + 1 end
	end
	--print(string.format("# of positive samples = %d\n",npos))
	--print(string.format("# of negative samples = %d\n",nneg))
	--print(string.format("# of total    samples = %d\n",#data))
	return data,maxdim
end


for k=1,features do
  
  trainDataset = createSVMDataset(TTrain2, trainLabelFileTENSOR, k)
  testDataset = createSVMDataset(TTest2, testLabelFileTENSOR, k)
  
  model = libsvm.train(trainDataset, '-g 1000000000000000000 -c 10000 -h 0 -e 0.000001')

  labels,accuracy,dec,output = libsvm.predict(trainDataset,model)
  PredTraining1 = dec

  labels,accuracy,dec,output = libsvm.predict(testDataset,model)
  PredTest1 = dec
   

  for i=1,TTrain2:size(1) do
   TTrain2[i][k]=PredTraining1[i]  
  end

  for i=1,TTest2:size(1) do
    TTest2[i][k]=PredTest1[i]  
  end
  
    
end

local outputFile1 = path .. 'WorkingSVM/' .. features .. 'TrainSVM.th7'
torch.save(outputFile1, TTrain2)

local outputFile2 = path .. 'WorkingSVM/' .. features .. 'TestSVM.th7'
torch.save(outputFile2, TTest2)


time = os.date("*t")
print(time.hour .. ":" .. time.min .. ":" .. time.sec)


--print(trainDataset[1][2][2])





